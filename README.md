# Speed Test NextGen (Windows 10/11)

Красивый тестер скорости на PyQt5 + PyQt-Fluent-Widgets с тёмной темой, анимациями и сохранением результатов.

## Возможности
- **Тёмная и светлая темы**: мгновенное переключение оформления через `ui/settings_interface.py`.
- **Быстрый тест скорости**: измерение ping, download и upload с анимированным `ProgressRing`.
- **Точный тест**: три последовательных прогона на разных серверах с усреднением результатов.
- **Управление серверами**: выбор приоритетного сервера, избранные и фильтрация в `ui/servers_interface.py`.
- **Журнал событий**: логи в UI и (при наличии консоли) в stdout всегда активны.
- **История измерений**: автоматическое сохранение в `C:/Users/<Пользователь>/Documents/SpeedtestNextGen/data/results.jsonl` и просмотр через `ui/history_interface.py`.
- **Альтернативный движок**: поддержка официального Ookla Speedtest CLI (`speedtest.exe`) как альтернативы встроенной библиотеке `speedtest-cli`.

## Запуск

- **Установите зависимости**:
  ```bash
  pip install -r requirements.txt
  ```
- **Запустите приложение из корня репозитория**:
  ```bash
  python -m fluent_speedtest
  ```
  Эта команда гарантирует корректные относительные импорты.
- **Альтернатива (из каталога `fluent_speedtest/`)**:
  ```bash
  python main.py
  ```

> Требуется установленный пакет `qfluentwidgets`.

---

## Требования

- Windows 10/11 (поддерживаемая целевая платформа)
- Python 3.10+ (проект протестирован на 3.12/3.13)
- Зависимости из `requirements.txt`:
  - PyQt5
  - PyQt-Fluent-Widgets
  - speedtest-cli
  - (опционально) Внешний бинарник [Ookla Speedtest CLI](https://www.speedtest.net/apps/cli) — если используете режим "Ookla CLI".

## Скриншоты

### Главный экран
![Главный экран](docs/screenshots/1.png)

### Выбор сервера
![Выбор сервера](docs/screenshots/2.png)

![История тестов](docs/screenshots/3.png)

### Настройки
![Настройки](docs/screenshots/4.png)

## Структура проекта

```
fluent_speedtest/
  core/
    settings.py         # настройки (Documents/SpeedtestNextGen/settings.json)
    speedtest_client.py # обёртка над speedtest-cli (выбор/поиск сервера, тест)
    worker.py           # фоновый исполнитель для GUI (QThread + сигналы)
    storage.py          # сохранение/загрузка результатов
  ui/
    test_interface.py       # экран запуска теста (обычный и точный режимы)
    servers_interface.py    # выбор сервера и управление избранными
    history_interface.py    # история результатов
    settings_interface.py   # настройки (тема и единицы скорости)
  assets/
    app.ico             # иконка приложения (для сборки exe)
  app_window.py         # главное окно и навигация
  logging_utils.py      # логирование в консоль и в UI
  main.py               # точка входа при запуске скриптом
  __main__.py           # точка входа при запуске модулем: python -m fluent_speedtest
  README.md
  requirements.txt
```

## Функциональные экраны

- **Экран «Тест скорости» (`ui/test_interface.py`)**: запуск быстрого и точного тестов, отображение прогресса, логов и карточек с результатами.
- **Экран «Серверы» (`ui/servers_interface.py`)**: загрузка списка серверов, выбор предпочтительного сервера, добавление в избранные и фильтр «Только избранные».
- **Экран «История» (`ui/history_interface.py`)**: отображение прошлых измерений с автоматическим пересчётом единиц скорости и очисткой истории.
- **Экран «Настройки» (`ui/settings_interface.py`)**: выбор единиц скорости и темы оформления.

## Архитектура и фоновые задачи

- **`core/speedtest_client.py`**: обёртка над `speedtest-cli`, реализующая выбор серверов, повторные попытки и обход ошибок 403.
- **`core/worker.py`**: фоновые исполнители `SpeedtestWorker` и `PreciseSpeedtestWorker`, которые запускают тесты в отдельных потоках и уведомляют UI через сигналы.
- **`logging_utils.py`**: настройка логов для отправки сообщений в UI и stdout (если доступен консольный вывод).
- **`core/storage.py`**: запись результатов в JSONL и очистка истории.

## Настройки

- **Файл настроек**: `C:/Users/<Пользователь>/Documents/SpeedtestNextGen/settings.json`.
- **Ключи**:
  - `theme`: `Dark` или `Light`.
  - `units`: `Mbps` или `MB/s`.
  - `server_id`: числовой ID выбранного сервера (опционально).
  - `favorite_server_ids`: список ID избранных серверов (опционально).
  - `engine`: `python` (по умолчанию) или `ookla` — выбор движка измерений.
  - `ookla_path`: путь к `speedtest.exe` (если пусто — будет взят из `PATH`).
  - `ookla_timeout`: таймаут выполнения `speedtest.exe` в секундах (по умолчанию `90`).
- **Хранение данных**: результаты тестов лежат в `C:/Users/<Пользователь>/Documents/SpeedtestNextGen/data/results.jsonl`.

## Альтернативный движок: Ookla Speedtest CLI

Для более близких к официальному speedtest.net результатов вы можете использовать официальный CLI от Ookla.

### Установка

- Скачайте `speedtest` с сайта: https://www.speedtest.net/apps/cli
- Либо через пакетный менеджер:
  - Windows: `winget install -e --id Ookla.Speedtest.CLI`

### Настройка в приложении

- Откройте раздел `Настройки`.
- В поле "Движок теста" выберите `Ookla CLI (speedtest.exe)`.
- Укажите путь к `speedtest.exe` (если он не в `PATH`).
- При необходимости задайте таймаут (30/60/90/120 сек).

Во время запуска теста приложение автоматически добавляет флаги `--accept-license` и `--accept-gdpr`, формирует JSON-вывод (`--format=json`) и парсит результат. Отмена теста завершает процесс `speedtest.exe` корректно.

Формат сохраняемых результатов не меняется — поля `ping_ms`, `download_bps`, `upload_bps` и `server.*` совместимы с UI. Дополнительно в результат добавляется поле `engine: "ookla"` для справки.

## Использование

- **Раздел «Тест скорости»**:
  - **«Тест»**: запускает стандартное измерение без блокировки UI.
  - **«Точный тест»**: выполняет до трёх прогонов на разных серверах и усредняет результаты.
  - **«Стоп»**: мгновенно отменяет текущий тест и завершает поток.
  - **Журнал**: отображает все лог-сообщения, включая стадии теста и ошибки.

- **Раздел «Серверы»**:
  - **«Обновить»**: загружает актуальный список ближайших серверов (до 300 записей).
  - **«Выбрать сервер»**: сохраняет `server_id` в настройках.
  - **«Сбросить выбор»**: возвращает автоматический подбор лучшего сервера.
  - **«В избранное ⭐» / «Убрать из избранных»**: управляет списком `favorite_server_ids`.
  - **«Только избранные»**: фильтрует таблицу по избранным серверам.

- **Раздел «История»**:
  - **«Обновить»**: перечитывает `results.jsonl` и отображает данные в выбранных единицах.
  - **«Очистить»**: удаляет историю измерений.

## Поведение выбора сервера и отмены

- **При заданном `server_id`**: используется выбранный сервер, при ошибке выполняется автоматический подбор.
- **При ошибке `NoMatchedServers`**: приложение логирует предупреждение и продолжает работу с оптимальным сервером.
- **Отмена теста**: кнопка «Стоп» устанавливает флаг отмены, прерывает download/upload и завершает тест корректно с логом «Тест отменён пользователем».

## Формат результатов

Каждый тест сохраняется одной строкой в `C:/Users/<Пользователь>/Documents/SpeedtestNextGen/data/results.jsonl`:

```json
{
  "timestamp": "2025-09-21T19:06:28",
  "ping_ms": 11.0,
  "download_bps": 72800000.0,
  "upload_bps": 73600000.0,
  "server": {
    "id": 62489,
    "sponsor": "SKY-NET",
    "name": "Odesa",
    "country": "Ukraine",
    "host": "speedtest.sky-net.od.ua:8080"
  }
}
```

## Частые вопросы и проблемы

- **ImportError: attempted relative import with no known parent package**: запускайте через `python -m fluent_speedtest` из корня проекта.
- **NoMatchedServers при выборе сервера**: это штатно обрабатывается, приложение автоматически подберёт лучший сервер; при необходимости нажмите «Сбросить выбор».
- **Предупреждение `QThread: Destroyed while thread is still running`**: дождитесь завершения теста или нажмите «Стоп» перед закрытием приложения.
- **Нет установленного `qfluentwidgets`**: установите пакет командой `pip install PyQt-Fluent-Widgets`.

## Разработка

- **Форматирование**: стандартный Python style (PEP 8).
- **Версия приложения**: отображается в заголовке окна (`app_window.py`).
- **Полезные команды**:
  - `python -m fluent_speedtest` — запуск GUI.
  - Модули GUI располагаются в `ui/`.
  - Основная логика — в `core/`.

## Сборка (Nuitka)

Рекомендуется использовать готовые скрипты из папки `build_scripts/`:

```powershell
# Сборка в папку (standalone)
python build_scripts\build_folder.py -v 1.2.0

# Сборка в один файл (onefile)
python build_scripts\build_onefile.py -v 1.2.0
```

Скрипты автоматически подберут компилятор: для Python 3.13+ будет использован MSVC, для более ранних — MinGW-w64.

- Иконка exe берётся из `assets/app.ico`

## Благодарности

- **speedtest-cli** — измерение скорости
- **Ookla Speedtest CLI** — официальный CLI-клиент
- **QFluentWidgets** — красивые Fluent-компоненты для PyQt